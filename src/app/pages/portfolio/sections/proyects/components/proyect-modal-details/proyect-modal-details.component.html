<div class="modal-overlay" 
     [ngClass]="modalClasses()" 
     (click)="onClose()" 
     *ngIf="isModalVisible() && currentProject()" 
     role="dialog"
     [attr.aria-label]="'Detalles del proyecto ' + currentProject()!.name" 
     aria-modal="true">

  
  <div class="modal-content" 
       [class.mobile]="isMobile" 
       [class.tablet]="viewportSize() === 'tablet'"
       (click)="$event.stopPropagation()">

    
    <header class="modal-header">
      <div class="project-info">
        <div class="project-meta">
          <div class="status-indicator" 
               [class]="getStatusClass(currentProject()!.status)"
               [attr.aria-label]="'Estado: ' + currentProject()!.status"></div>
          <span class="status-text">{{ currentProject()!.status | titlecase }}</span>
        </div>
        <h1 class="project-title">{{ currentProject()!.name }}</h1>
        <p class="project-type">{{ currentProject()!.type | titlecase }}</p>
      </div>

      
      <nav class="modal-navigation" [class.mobile]="isMobile">
        <button class="nav-btn" 
                [disabled]="!hasPreviousProject()" 
                (click)="onPreviousProject()"
                [attr.aria-label]="'Proyecto anterior'" 
                type="button">
          <svg class="nav-icon" aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <span class="project-counter"
              [attr.aria-label]="'Proyecto ' + currentProjectIndex() + ' de ' + totalProjects()">
          {{ currentProjectIndex() }} / {{ totalProjects() }}
        </span>

        <button class="nav-btn" 
                [disabled]="!hasNextProject()" 
                (click)="onNextProject()"
                [attr.aria-label]="'Siguiente proyecto'" 
                type="button">
          <svg class="nav-icon" aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </nav>

      
      <button class="close-btn" 
              (click)="onClose()" 
              [attr.aria-label]="'Cerrar modal'" 
              type="button">
        <svg aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </header>

    
    <nav class="tabs-nav" role="tablist">
      <button *ngFor="let tab of getTabTypes(); trackBy: trackByFeature" 
              class="tab-btn"
              [class.active]="activeTab() === tab" 
              (click)="onTabChange(tab)"
              [attr.aria-label]="'Pestaña ' + getTabLabel(tab)" 
              [attr.aria-selected]="activeTab() === tab" 
              role="tab"
              type="button">
        <svg class="tab-icon" aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none">
          <ng-container [ngSwitch]="tab">
            <!-- Resumen -->
            <g *ngSwitchCase="'overview'">
              <path d="M3 3v18h18V3H3zm16 16H5V5h14v14z" fill="currentColor"/>
              <path d="M7 7h10v2H7zm0 4h10v2H7zm0 4h7v2H7z" fill="currentColor"/>
            </g>
            <!-- Galería -->
            <g *ngSwitchCase="'gallery'">
              <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" fill="currentColor"/>
            </g>
          </ng-container>
        </svg>
        <span class="tab-text">{{ getTabLabel(tab) }}</span>
      </button>
    </nav>

    
    <main class="modal-body" *ngIf="currentProjectDetails()">

      
      <section class="tab-content" 
               [class.active]="activeTab() === 'overview'"
               role="tabpanel" 
               [attr.aria-labelledby]="'tab-overview'">

        <article class="overview-section">
          <h2 class="section-title">Descripción del Proyecto</h2>
          <p class="extended-description">
            {{ getContextualDescription(currentProjectDetails()!.extendedDescription) }}
          </p>
        </article>

        <section class="objectives-section">
          <h3 class="section-title">Objetivos del Proyecto</h3>
          <ul class="objectives-list" role="list">
            <li *ngFor="let objective of currentProjectDetails()!.objectives; trackBy: trackByObjective"
                class="objective-item" 
                role="listitem">
              <svg class="objective-icon" aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <circle cx="12" cy="12" r="6" fill="currentColor"/>
                <circle cx="12" cy="12" r="2" fill="white"/>
              </svg>
              {{ objective }}
            </li>
          </ul>
        </section>

        <section class="features-section">
          <h3 class="section-title">Características Principales</h3>
          <div class="features-grid">
            <div *ngFor="let feature of currentProjectDetails()!.keyFeatures.slice(0, getResponsiveFeatureCount()); trackBy: trackByFeature"
                 class="feature-card">
              <svg class="feature-icon" aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none">
                <polygon points="12,2 15.09,8.26 22,9 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9 8.91,8.26" fill="currentColor"/>
              </svg>
              <span class="feature-text">{{ feature }}</span>
            </div>
          </div>

          
          <button *ngIf="viewportSize() === 'mobile' && currentProjectDetails()!.keyFeatures.length > 6"
                  class="show-more-btn" 
                  (click)="onTabChange('gallery')" 
                  type="button">
            Ver más características →
          </button>
        </section>

       <section class="tech-stack-section">
          <h3 class="section-title">Tecnologías Utilizadas</h3>
          <div class="tech-stack-grid">
            <div *ngFor="let tech of currentProject()!.techStack; trackBy: trackByTech" 
                 class="tech-item"
                 [class]="tech | techClass">
              <svg class="tech-icon" aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                <path d="M9 9h6v6H9z" fill="currentColor"/>
              </svg>
              <span class="tech-name">{{ tech }}</span>
            </div>
          </div>
        </section>

        <section class="architecture-section">
          <h3 class="section-title">Arquitectura</h3>
          <p class="architecture-description">
            {{ currentProjectDetails()!.architecture | modalResponsive:viewportSize() }}
          </p>
        </section>

        <section class="process-section" *ngIf="viewportSize() !== 'mobile'">
          <h3 class="section-title">Proceso de Desarrollo</h3>
          <div class="process-info">
            <div class="process-item">
              <span class="process-label">Metodología:</span>
              <span class="process-value">{{ currentProjectDetails()!.developmentProcess.methodology }}</span>
            </div>
            <div class="process-item">
              <span class="process-label">Duración:</span>
              <span class="process-value">{{ currentProjectDetails()!.developmentProcess.duration | formatDuration }}</span>
            </div>
            <div class="process-item">
              <span class="process-label">Equipo:</span>
              <span class="process-value">{{ currentProjectDetails()!.developmentProcess.teamSize }} desarrolladores</span>
            </div>
          </div>
        </section>

        <section class="learnings-section" *ngIf="viewportSize() === 'desktop'">
          <h3 class="section-title">Aprendizajes Clave</h3>
          <ul class="learnings-list" role="list">
            <li *ngFor="let learning of currentProjectDetails()!.learnings trackBy: trackByLearning"
                class="learning-item" 
                role="listitem">
              <svg class="learning-icon" aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z" fill="currentColor"/>
              </svg>
              {{ learning }}
            </li>
          </ul>
        </section>
      </section>

      
      <section class="tab-content" 
               [class.active]="activeTab() === 'gallery'"
               role="tabpanel" 
               [attr.aria-labelledby]="'tab-gallery'">

        
        <div class="gallery-viewer">
          <div class="gallery-main" *ngIf="currentGalleryItem()">

            
            <div class="media-container"
                 *ngIf="currentGalleryItem()!.type === 'image' || currentGalleryItem()!.type === 'gif'">
              <img [src]="currentGalleryItem()!.url" 
                   [alt]="currentGalleryItem()!.title"
                   class="gallery-image" 
                   (load)="onImageLoad($event)" 
                   (error)="onImageError($event)"
                   (click)="showLightboxModal()" 
                   loading="lazy">

              <button class="zoom-btn" 
                      (click)="showLightboxModal()"
                      [attr.aria-label]="'Ampliar imagen: ' + currentGalleryItem()!.title" 
                      type="button">
                <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                  <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <line x1="11" y1="8" x2="11" y2="14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <line x1="8" y1="11" x2="14" y2="11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </div>

            
            <div class="media-container" *ngIf="currentGalleryItem()!.type === 'video'">
              <video class="gallery-video" 
                     [src]="currentGalleryItem()!.url" 
                     controls 
                     preload="metadata"
                     (play)="onVideoPlay()" 
                     (pause)="onVideoPause()"
                     [attr.aria-label]="'Video: ' + currentGalleryItem()!.title">
                Tu navegador no soporta video HTML5.
              </video>
            </div>

            
            <button class="gallery-nav prev" 
                    (click)="onGalleryPrevious()"
                    [disabled]="!hasGalleryPrevious()" 
                    [attr.aria-label]="'Imagen anterior'"
                    type="button">
              <svg aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>

            <button class="gallery-nav next" 
                    (click)="onGalleryNext()" 
                    [disabled]="!hasGalleryNext()"
                    [attr.aria-label]="'Siguiente imagen'" 
                    type="button">
              <svg aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>

          
          <div class="gallery-info" *ngIf="currentGalleryItem()">
            <h4 class="gallery-title">{{ currentGalleryItem()!.title }}</h4>
            <p class="gallery-description" *ngIf="currentGalleryItem()!.description">
              {{ currentGalleryItem()!.description! | modalResponsive:viewportSize() }}
            </p>

            
            <div class="gallery-counter" *ngIf="isMobile">
              <span>{{ currentGalleryIndex() + 1 }} / {{ currentProjectDetails()!.gallery.length }}</span>
            </div>
          </div>
        </div>

        
        <section class="gallery-thumbnails" *ngIf="!isMobile">
          <div class="thumbnails-grid">
            <button *ngFor="let item of currentProjectDetails()!.gallery; trackBy: trackByGalleryItem; let i = index"
                    class="thumbnail-btn" 
                    [class.active]="i === currentGalleryIndex()"
                    (click)="onGalleryItemClick(i)" 
                    [attr.aria-label]="'Ver ' + item.title" 
                    type="button">

              <img *ngIf="item.type === 'image' || item.type === 'gif'" 
                   [src]="item.thumbnail || item.url"
                   [alt]="item.title" 
                   class="thumbnail-img" 
                   loading="lazy">

              <div *ngIf="item.type === 'video'" class="thumbnail-video">
                <svg class="video-icon" aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <polygon points="5,3 19,12 5,21" fill="currentColor"/>
                </svg>
              </div>

              <div class="thumbnail-overlay">
                <span class="thumbnail-type">{{ item.type }}</span>
              </div>
            </button>
          </div>
        </section>
      </section>

    </main>

    
    <footer class="modal-footer" [class.mobile]="isMobile">
      <!-- <button class="action-btn secondary" 
              (click)="onActionClick('code')" 
              *ngIf="currentProject()!.codeUrl"
              type="button" 
              [attr.aria-label]="'Ver código de ' + currentProject()!.name">
        <svg class="btn-icon" aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none">
          <polyline points="16,18 22,12 16,6" stroke="currentColor" stroke-width="2" fill="none"/>
          <polyline points="8,6 2,12 8,18" stroke="currentColor" stroke-width="2" fill="none"/>
        </svg>
        <span class="btn-text">{{ viewportSize() === 'mobile' ? 'Código' : 'Ver Código' }}</span>
      </button>

      <button class="action-btn primary" 
              (click)="onActionClick('demo')" 
              *ngIf="currentProject()!.demoUrl"
              type="button" 
              [attr.aria-label]="'Ver demo de ' + currentProject()!.name">
        <svg class="btn-icon" aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
          <path d="M2 12h20" stroke="currentColor" stroke-width="2"/>
          <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" stroke="currentColor" stroke-width="2"/>
        </svg>
        <span class="btn-text">{{ viewportSize() === 'mobile' ? 'Demo' : 'Ver Proyecto' }}</span>
      </button> -->
    </footer>

  </div>
</div>


<div class="lightbox-overlay" 
     [class.visible]="showLightbox()" 
     (click)="onCloseLightbox()"
     *ngIf="showLightbox() && currentGalleryItem()" 
     role="dialog" 
     aria-modal="true"
     [attr.aria-label]="'Imagen ampliada: ' + currentGalleryItem()!.title">

  <div class="lightbox-content" (click)="$event.stopPropagation()">
    <img [src]="currentGalleryItem()!.url" 
         [alt]="currentGalleryItem()!.title" 
         class="lightbox-image"
         (load)="onImageLoad($event)" 
         (error)="onImageError($event)">

    <button class="lightbox-close" 
            (click)="onCloseLightbox()" 
            [attr.aria-label]="'Cerrar imagen ampliada'"
            type="button">
      <svg aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <div class="lightbox-info" *ngIf="currentGalleryItem()!.description">
      <h4>{{ currentGalleryItem()!.title }}</h4>
      <p>{{ currentGalleryItem()!.description }}</p>
    </div>

    
    <button class="lightbox-nav prev" 
            (click)="onGalleryPrevious(); $event.stopPropagation()"
            [disabled]="!hasGalleryPrevious()" 
            [attr.aria-label]="'Imagen anterior'" 
            type="button" 
            *ngIf="!isMobile">
      <svg aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <button class="lightbox-nav next" 
            (click)="onGalleryNext(); $event.stopPropagation()"
            [disabled]="!hasGalleryNext()" 
            [attr.aria-label]="'Siguiente imagen'" 
            type="button" 
            *ngIf="!isMobile">
      <svg aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
</div>


<div class="modal-loading" 
     *ngIf="isLoading()" 
     [attr.aria-label]="'Cargando detalles del proyecto'">
  <svg class="loading-spinner" aria-hidden="true" width="40" height="40" viewBox="0 0 24 24" fill="none">
    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-dasharray="31.416" stroke-dashoffset="31.416">
      <animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416" repeatCount="indefinite"/>
      <animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416" repeatCount="indefinite"/>
    </circle>
  </svg>
  <span class="loading-text">Cargando detalles...</span>
</div>


<div class="sr-only" aria-live="polite">
  <span *ngIf="isModalVisible() && currentProject()">
    Mostrando detalles de {{ currentProject()!.name }}.
    Pestaña activa: {{ getTabLabel(activeTab()) }}.
    {{ activeTab() === 'gallery' ? 'Imagen ' + (currentGalleryIndex() + 1) + ' de ' + currentProjectDetails()!.gallery.length : '' }}
  </span>
</div>

